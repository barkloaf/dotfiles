#!/usr/bin/env zsh

# script used to upload flameshot screenshots to a Zipline server (https://zipline.diced.sh/)

source <(grep = $XDG_CONFIG_HOME/zipline/zipline.conf)

mkdir -p $screenshot_folder
target="$screenshot_folder/$(date +$date_str).png"

flameshot gui -r > $target

if [[ $(file --mime-type -b $target) != "image/png" ]]; then
	rm $target
	notify-send "Screenshot aborted" -a "Flameshot" && exit 1
fi

choice=$(rofi -dmenu -input $urls | read selection && echo ${selection})

if [[ $choice = "Abort" || $choice = "" ]]; then
	rm $target
	notify-send "Screenshot aborted" -a "Flameshot" && exit 1
fi

xclip -selection clipboard -t image/png -i $target

message="Copied to clipboard"

if [[ $choice = "Copy to clipboard" ]]; then
	message+="."
else
	output=$(curl -H "authorization: $key" $api_url -F file=@$target -H "content-type: multipart/form-data" | jq -r '.files[0].url' | tr -d '\n')
	link="$choice/${output##*/}"
	message+=": $link"
	echo -n $link | xclip -sel c
fi

notify-send "$message" -a "Flameshot" -i $target
